#include	"iextreme.h"
#include	"GameData.h"
#include	"GameParam.h"
#include	"stage.h"
#include	"sceneMain.h"
#include	"player.h"

//*****************************************************************************************************************************
//
//		プレイヤークラス
//
//*****************************************************************************************************************************

//*****************************************************************************************************************************
//	初期化・解放
//*****************************************************************************************************************************
//------------------------------------------------------
//	初期化・解放
//------------------------------------------------------
cPlayer::cPlayer()
{
	//	初期設定
	this->pos = pos;
	angle = .0f;
}

cPlayer::~cPlayer()
{
}

//*****************************************************************************************************************************
//	更新
//*****************************************************************************************************************************
bool cPlayer::Update( PlayerParam& param )
{
	//	左右判定
	float x1 = param.pos.x,  z1 = param.pos.z;
	float x2 = sinf(param.angle), z2 = cosf(param.angle);	
	//	外積
	float g = x1*z2 - x2*z1;
	//	補整量調整	
	float d = sqrtf( x1*x1 + z1*z1 );
	if( d > 0.3f )
	{
		float n = (x1*x2 + z1*z2) / d;
		float adjust = (1-n) * 2.0f;
		if( adjust > 0.9f ) adjust = 0.9f;
		//	方向転換
		if( g < 0 ) param.angle -= adjust;
		else param.angle += adjust;

		Vector3	move( param.pos.x, 0, param.pos.z );
		move = move / d * 0.5f;
		param.pos = MoveCheck( param.pos, move );

	}
	return true;
}

//*****************************************************************************************************************************
//
//		プレイヤー管理クラス
//
//*****************************************************************************************************************************

//*****************************************************************************************************************************
//	初期化・解放
//*****************************************************************************************************************************
//------------------------------------------------------
//	初期化
//------------------------------------------------------
cPlayerManager::cPlayerManager( GameParam* gameParam )
{
	this->gameParam = gameParam; 
	//	全プレイヤー初期化
	for( int p=0 ; p<PLAYER_MAX ; p++ )
	{
		player[p] = NULL;
	}
}

//------------------------------------------------------
//	解放
//------------------------------------------------------
cPlayerManager::~cPlayerManager()
{
	//	全プレイヤー解放
	for( int p=0 ; p<PLAYER_MAX ; p++ ) delete player[p];
}

//*****************************************************************************************************************************
//	更新
//*****************************************************************************************************************************
void cPlayerManager::Update( int id )
{
	PlayerParam param = gameParam->getPlayerParam(id);
	//	プレイヤー更新
	if( player[id]->Update( param ) == false )
	{
		delete player[id];
		player[id] = NULL;
	} else {
		gameParam->SetPlayerParam( id, param.pos, param.angle );
	}
}

//*****************************************************************************************************************************
//	プレイヤー生成
//*****************************************************************************************************************************
void cPlayerManager::Set( int id, int type )
{
	//	存在チェック
	if( player[id] != NULL ) return;
	//	プレイヤー生成
	player[id] = new cPlayer();
}
